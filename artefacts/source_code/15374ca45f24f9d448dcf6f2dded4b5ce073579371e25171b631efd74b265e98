public void writeToParcel(Parcel parcel, int flags){
    final boolean collectPendingIntents = (allPendingIntents == null);
    if (collectPendingIntents) {
        PendingIntent.setOnMarshaledListener((PendingIntent intent, Parcel out, int outFlags) -> {
            if (parcel == out) {
                synchronized (this) {
                    if (allPendingIntents == null) {
                        allPendingIntents = new ArraySet<>();
                    }
                    allPendingIntents.add(intent);
                }
            }
        });
    }
    try {
        writeToParcelImpl(parcel, flags);
        synchronized (this) {
            parcel.writeArraySet(allPendingIntents);
        }
    } finally {
        if (collectPendingIntents) {
            PendingIntent.setOnMarshaledListener(null);
        }
    }
}