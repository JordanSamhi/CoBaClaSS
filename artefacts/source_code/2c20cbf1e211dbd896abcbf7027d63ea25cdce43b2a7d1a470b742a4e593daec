public void flush(){
    if (mStream == null) {
        return;
    }
    if (mDepth != 0) {
        return;
    }
    if (mCompacted) {
        return;
    }
    compactIfNecessary();
    final byte[] data = mBuffer.getBytes(mBuffer.getReadableSize());
    try {
        mStream.write(data);
        mStream.flush();
    } catch (IOException ex) {
        throw new RuntimeException("Error flushing proto to stream", ex);
    }
}