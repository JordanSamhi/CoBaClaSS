public static void copyStream(InputStream in, OutputStream out, int limit) throws IOException{
    int bufferSize = Math.min(MAX_COPY_BUFFER_SIZE, limit);
    byte[] buffer = new byte[bufferSize];
    int copied = 0;
    while (copied < limit) {
        int maxReadSize = Math.min(bufferSize, limit - copied);
        int read = in.read(buffer, 0, maxReadSize);
        if (read < 0) {
            return;
        }
        out.write(buffer, 0, read);
        copied += read;
    }
}