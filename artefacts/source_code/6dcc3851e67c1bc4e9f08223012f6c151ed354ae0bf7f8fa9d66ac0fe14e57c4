public void powerOffRadioSafely(){
    synchronized (this) {
        if (!mPendingRadioPowerOffAfterDataOff) {
            int dds = SubscriptionManager.getDefaultDataSubscriptionId();
            if (mPhone.areAllDataDisconnected() && (dds == mPhone.getSubId() || (dds != mPhone.getSubId() && ProxyController.getInstance().areAllDataDisconnected(dds)))) {
                for (int transport : mTransportManager.getAvailableTransports()) {
                    if (mPhone.getDcTracker(transport) != null) {
                        mPhone.getDcTracker(transport).cleanUpAllConnections(Phone.REASON_RADIO_TURNED_OFF);
                    }
                }
                if (DBG)
                    log("Data disconnected, turn off radio right away.");
                hangupAndPowerOff();
            } else {
                if (mPhone.isPhoneTypeGsm() && mPhone.isInCall()) {
                    mPhone.mCT.mRingingCall.hangupIfAlive();
                    mPhone.mCT.mBackgroundCall.hangupIfAlive();
                    mPhone.mCT.mForegroundCall.hangupIfAlive();
                }
                for (int transport : mTransportManager.getAvailableTransports()) {
                    if (mPhone.getDcTracker(transport) != null) {
                        mPhone.getDcTracker(transport).cleanUpAllConnections(Phone.REASON_RADIO_TURNED_OFF);
                    }
                }
                if (dds != mPhone.getSubId() && !ProxyController.getInstance().areAllDataDisconnected(dds)) {
                    if (DBG)
                        log("Data is active on DDS.  Wait for all data disconnect");
                    ProxyController.getInstance().registerForAllDataDisconnected(dds, this, EVENT_ALL_DATA_DISCONNECTED);
                    mPendingRadioPowerOffAfterDataOff = true;
                }
                Message msg = Message.obtain(this);
                msg.what = EVENT_SET_RADIO_POWER_OFF;
                msg.arg1 = ++mPendingRadioPowerOffAfterDataOffTag;
                if (sendMessageDelayed(msg, 30000)) {
                    if (DBG)
                        log("Wait upto 30s for data to disconnect, then turn off radio.");
                    mPendingRadioPowerOffAfterDataOff = true;
                } else {
                    log("Cannot send delayed Msg, turn off radio right away.");
                    hangupAndPowerOff();
                    mPendingRadioPowerOffAfterDataOff = false;
                }
            }
        }
    }
}