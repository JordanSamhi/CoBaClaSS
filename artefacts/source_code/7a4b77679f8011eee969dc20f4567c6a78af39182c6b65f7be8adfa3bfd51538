public static int getLocalPortFromPhysicalAddress(int targetPhysicalAddress, int myPhysicalAddress){
    if (myPhysicalAddress == targetPhysicalAddress) {
        return TARGET_SAME_PHYSICAL_ADDRESS;
    }
    int mask = 0xF000;
    int finalMask = 0xF000;
    int maskedAddress = myPhysicalAddress;
    while (maskedAddress != 0) {
        maskedAddress = myPhysicalAddress & mask;
        finalMask |= mask;
        mask >>= 4;
    }
    int portAddress = targetPhysicalAddress & finalMask;
    if ((portAddress & (finalMask << 4)) != myPhysicalAddress) {
        return TARGET_NOT_UNDER_LOCAL_DEVICE;
    }
    mask <<= 4;
    int port = portAddress & mask;
    while ((port >> 4) != 0) {
        port >>= 4;
    }
    return port;
}