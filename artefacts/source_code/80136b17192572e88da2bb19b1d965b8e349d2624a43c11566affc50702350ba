public synchronized void writeOnImsConnectionState(int phoneId, int state, ImsReasonInfo reasonInfo){
    ImsConnectionState imsState = new ImsConnectionState();
    imsState.state = state;
    if (reasonInfo != null) {
        TelephonyProto.ImsReasonInfo ri = new TelephonyProto.ImsReasonInfo();
        ri.reasonCode = reasonInfo.getCode();
        ri.extraCode = reasonInfo.getExtraCode();
        String extraMessage = reasonInfo.getExtraMessage();
        if (extraMessage != null) {
            ri.extraMessage = extraMessage;
        }
        imsState.reasonInfo = ri;
    }
    if (mLastImsConnectionState.get(phoneId) != null && Arrays.equals(ImsConnectionState.toByteArray(mLastImsConnectionState.get(phoneId)), ImsConnectionState.toByteArray(imsState))) {
        return;
    }
    mLastImsConnectionState.put(phoneId, imsState);
    TelephonyEvent event = new TelephonyEventBuilder(phoneId).setImsConnectionState(imsState).build();
    addTelephonyEvent(event);
    annotateInProgressCallSession(event.timestampMillis, phoneId, new CallSessionEventBuilder(TelephonyCallSession.Event.Type.IMS_CONNECTION_STATE_CHANGED).setImsConnectionState(event.imsConnectionState));
    annotateInProgressSmsSession(event.timestampMillis, phoneId, new SmsSessionEventBuilder(SmsSession.Event.Type.IMS_CONNECTION_STATE_CHANGED).setImsConnectionState(event.imsConnectionState));
}