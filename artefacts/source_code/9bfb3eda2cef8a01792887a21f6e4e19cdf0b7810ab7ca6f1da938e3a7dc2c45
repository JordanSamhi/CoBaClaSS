public void onMMIDone(MmiCode mmi){
    if (mPendingMMIs.remove(mmi) || (isPhoneTypeGsm() && (mmi.isUssdRequest() || ((GsmMmiCode) mmi).isSsInfo()))) {
        ResultReceiver receiverCallback = mmi.getUssdCallbackReceiver();
        if (receiverCallback != null) {
            Rlog.i(LOG_TAG, "onMMIDone: invoking callback: " + mmi);
            int returnCode = (mmi.getState() == MmiCode.State.COMPLETE) ? TelephonyManager.USSD_RETURN_SUCCESS : TelephonyManager.USSD_RETURN_FAILURE;
            sendUssdResponse(mmi.getDialString(), mmi.getMessage(), returnCode, receiverCallback);
        } else {
            Rlog.i(LOG_TAG, "onMMIDone: notifying registrants: " + mmi);
            mMmiCompleteRegistrants.notifyRegistrants(new AsyncResult(null, mmi, null));
        }
    } else {
        Rlog.i(LOG_TAG, "onMMIDone: invalid response or already handled; ignoring: " + mmi);
    }
}