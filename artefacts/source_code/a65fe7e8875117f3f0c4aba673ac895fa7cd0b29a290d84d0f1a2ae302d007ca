public void requestPictureInPictureMode(IBinder token) throws RemoteException{
    mAmInternal.enforceCallingPermission(Manifest.permission.MANAGE_ACTIVITY_STACKS, "requestPictureInPictureMode");
    final long origId = Binder.clearCallingIdentity();
    try {
        synchronized (mGlobalLock) {
            final ActivityRecord activity = ActivityRecord.forTokenLocked(token);
            if (activity == null) {
                return;
            }
            if (isInPictureInPictureMode(activity)) {
                throw new IllegalStateException("Activity is already in PIP mode");
            }
            final boolean canEnterPictureInPicture = activity.checkEnterPictureInPictureState("requestPictureInPictureMode", false);
            if (!canEnterPictureInPicture) {
                throw new IllegalStateException("Requested PIP on an activity that doesn't support it");
            }
            try {
                final ClientTransaction transaction = ClientTransaction.obtain(activity.app.getThread(), activity.token);
                transaction.addCallback(EnterPipRequestedItem.obtain());
                getLifecycleManager().scheduleTransaction(transaction);
            } catch (Exception e) {
                Slog.w(TAG, "Failed to send enter pip requested item: " + activity.intent.getComponent(), e);
            }
        }
    } finally {
        Binder.restoreCallingIdentity(origId);
    }
}