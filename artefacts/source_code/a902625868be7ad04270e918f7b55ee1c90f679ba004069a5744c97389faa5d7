public static AppIdToPackageMap getSnapshot(){
    List<PackageInfo> packages;
    try {
        packages = AppGlobals.getPackageManager().getInstalledPackages(PackageManager.MATCH_UNINSTALLED_PACKAGES | PackageManager.MATCH_DIRECT_BOOT_UNAWARE | PackageManager.MATCH_DIRECT_BOOT_AWARE, UserHandle.USER_SYSTEM).getList();
    } catch (RemoteException e) {
        throw e.rethrowFromSystemServer();
    }
    final Map<Integer, String> map = new HashMap<>();
    for (PackageInfo pkg : packages) {
        final int uid = pkg.applicationInfo.uid;
        if (pkg.sharedUserId != null && map.containsKey(uid)) {
            map.put(uid, "shared:" + pkg.sharedUserId);
        } else {
            map.put(uid, pkg.packageName);
        }
    }
    return new AppIdToPackageMap(map);
}