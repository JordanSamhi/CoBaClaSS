public AuthenticationToken newSyntheticPasswordAndSid(IGateKeeperService gatekeeper, byte[] hash, LockscreenCredential credential, int userId){
    AuthenticationToken result = AuthenticationToken.create();
    GateKeeperResponse response;
    if (hash != null) {
        try {
            response = gatekeeper.enroll(userId, hash, credential.getCredential(), result.deriveGkPassword());
        } catch (RemoteException e) {
            throw new IllegalStateException("Failed to enroll credential duing SP init", e);
        }
        if (response.getResponseCode() != GateKeeperResponse.RESPONSE_OK) {
            Slog.w(TAG, "Fail to migrate SID, assuming no SID, user " + userId);
            clearSidForUser(userId);
        } else {
            saveSyntheticPasswordHandle(response.getPayload(), userId);
        }
    } else {
        clearSidForUser(userId);
    }
    saveEscrowData(result, userId);
    return result;
}