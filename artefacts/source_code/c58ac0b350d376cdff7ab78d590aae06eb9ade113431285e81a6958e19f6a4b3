public byte[] generateAndStoreKey(PlatformEncryptionKey platformKey, int userId, int uid, String alias, @Nullable byte[] metadata) throws RecoverableKeyStorageException, KeyStoreException, InvalidKeyException{
    mKeyGenerator.init(KEY_SIZE_BITS);
    SecretKey key = mKeyGenerator.generateKey();
    WrappedKey wrappedKey = WrappedKey.fromSecretKey(platformKey, key, metadata);
    long result = mDatabase.insertKey(userId, uid, alias, wrappedKey);
    if (result == RESULT_CANNOT_INSERT_ROW) {
        throw new RecoverableKeyStorageException(String.format(Locale.US, "Failed writing (%d, %s) to database.", uid, alias));
    }
    long updatedRows = mDatabase.setShouldCreateSnapshot(userId, uid, true);
    if (updatedRows < 0) {
        Log.e(TAG, "Failed to set the shoudCreateSnapshot flag in the local DB.");
    }
    return key.getEncoded();
}