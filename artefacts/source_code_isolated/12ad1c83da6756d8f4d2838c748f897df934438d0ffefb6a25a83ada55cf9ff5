public void onReset(IVold vold, Runnable resetHandlerRunnable){
    if (!shouldHandle(null)) {
        return;
    }
    SparseArray<StorageUserConnection> connections = new SparseArray();
    synchronized (mLock) {
        mIsResetting = true;
        Slog.i(TAG, "Started resetting external storage service...");
        for (int i = 0; i < mConnections.size(); i++) {
            connections.put(mConnections.keyAt(i), mConnections.valueAt(i));
        }
    }
    for (int i = 0; i < connections.size(); i++) {
        StorageUserConnection connection = connections.valueAt(i);
        for (String sessionId : connection.getAllSessionIds()) {
            try {
                Slog.i(TAG, "Unmounting " + sessionId);
                vold.unmount(sessionId);
                Slog.i(TAG, "Unmounted " + sessionId);
            } catch (ServiceSpecificException | RemoteException e) {
                Slog.e(TAG, "Failed to unmount volume: " + sessionId, e);
            }
            try {
                Slog.i(TAG, "Exiting " + sessionId);
                connection.removeSessionAndWait(sessionId);
                Slog.i(TAG, "Exited " + sessionId);
            } catch (IllegalStateException | ExternalStorageServiceException e) {
                Slog.e(TAG, "Failed to exit session: " + sessionId + ". Killing MediaProvider...", e);
                killExternalStorageService(connections.keyAt(i));
                break;
            }
        }
        connection.close();
    }
    resetHandlerRunnable.run();
    synchronized (mLock) {
        mConnections.clear();
        mIsResetting = false;
        Slog.i(TAG, "Finished resetting external storage service");
    }
}