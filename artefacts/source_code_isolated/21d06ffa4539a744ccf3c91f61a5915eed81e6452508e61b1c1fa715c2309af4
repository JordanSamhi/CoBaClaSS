public static Message getMessageFromBundle(@NonNull Bundle bundle){
    try {
        if (!bundle.containsKey(KEY_TEXT) || !bundle.containsKey(KEY_TIMESTAMP)) {
            return null;
        } else {
            Person senderPerson = bundle.getParcelable(KEY_SENDER_PERSON);
            if (senderPerson == null) {
                CharSequence senderName = bundle.getCharSequence(KEY_SENDER);
                if (senderName != null) {
                    senderPerson = new Person.Builder().setName(senderName).build();
                }
            }
            Message message = new Message(bundle.getCharSequence(KEY_TEXT), bundle.getLong(KEY_TIMESTAMP), senderPerson, bundle.getBoolean(KEY_REMOTE_INPUT_HISTORY, false));
            if (bundle.containsKey(KEY_DATA_MIME_TYPE) && bundle.containsKey(KEY_DATA_URI)) {
                message.setData(bundle.getString(KEY_DATA_MIME_TYPE), (Uri) bundle.getParcelable(KEY_DATA_URI));
            }
            if (bundle.containsKey(KEY_EXTRAS_BUNDLE)) {
                message.getExtras().putAll(bundle.getBundle(KEY_EXTRAS_BUNDLE));
            }
            return message;
        }
    } catch (ClassCastException e) {
        return null;
    }
}