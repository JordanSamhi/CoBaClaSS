public void onCharacteristicWrite(String address, int status, int handle){
    if (VDBG) {
        Log.d(TAG, "onCharacteristicWrite() - Device=" + address + " handle=" + handle + " Status=" + status);
    }
    if (!address.equals(mDevice.getAddress())) {
        return;
    }
    synchronized (mDeviceBusyLock) {
        mDeviceBusy = false;
    }
    BluetoothGattCharacteristic characteristic = getCharacteristicById(mDevice, handle);
    if (characteristic == null)
        return;
    if ((status == GATT_INSUFFICIENT_AUTHENTICATION || status == GATT_INSUFFICIENT_ENCRYPTION) && (mAuthRetryState != AUTH_RETRY_STATE_MITM)) {
        try {
            final int authReq = (mAuthRetryState == AUTH_RETRY_STATE_IDLE) ? AUTHENTICATION_NO_MITM : AUTHENTICATION_MITM;
            mService.writeCharacteristic(mClientIf, address, handle, characteristic.getWriteType(), authReq, characteristic.getValue());
            mAuthRetryState++;
            return;
        } catch (RemoteException e) {
            Log.e(TAG, "", e);
        }
    }
    mAuthRetryState = AUTH_RETRY_STATE_IDLE;
    runOrQueueCallback(new Runnable() {

        @Override
        public void run() {
            final BluetoothGattCallback callback = mCallback;
            if (callback != null) {
                callback.onCharacteristicWrite(BluetoothGatt.this, characteristic, status);
            }
        }
    });
}