public void stopProtoLog(@Nullable PrintWriter pw, boolean writeToFile){
    if (!isProtoEnabled()) {
        return;
    }
    synchronized (mProtoLogEnabledLock) {
        logAndPrintln(pw, "Stop logging to " + mLogFile + ". Waiting for log to flush.");
        mProtoLogEnabled = mProtoLogEnabledLockFree = false;
        if (writeToFile) {
            writeProtoLogToFileLocked();
            logAndPrintln(pw, "Log written to " + mLogFile + ".");
        }
        if (mProtoLogEnabled) {
            logAndPrintln(pw, "ERROR: logging was re-enabled while waiting for flush.");
            throw new IllegalStateException("logging enabled while waiting for flush.");
        }
    }
    sCacheUpdater.run();
}