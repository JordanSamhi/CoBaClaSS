public int getTextRunCursor(int contextStart, int contextEnd, boolean isRtl, int offset, int cursorOpt, Paint p){
    int ret;
    int contextLen = contextEnd - contextStart;
    if (contextEnd <= mGapStart) {
        ret = p.getTextRunCursor(mText, contextStart, contextLen, isRtl, offset, cursorOpt);
    } else if (contextStart >= mGapStart) {
        ret = p.getTextRunCursor(mText, contextStart + mGapLength, contextLen, isRtl, offset + mGapLength, cursorOpt) - mGapLength;
    } else {
        char[] buf = TextUtils.obtain(contextLen);
        getChars(contextStart, contextEnd, buf, 0);
        ret = p.getTextRunCursor(buf, 0, contextLen, isRtl, offset - contextStart, cursorOpt) + contextStart;
        TextUtils.recycle(buf);
    }
    return ret;
}