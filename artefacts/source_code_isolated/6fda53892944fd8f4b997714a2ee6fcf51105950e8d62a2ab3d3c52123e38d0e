public static float getDesiredWidthWithLimit(CharSequence source, int start, int end, TextPaint paint, TextDirectionHeuristic textDir, float upperLimit){
    float need = 0;
    int next;
    for (int i = start; i <= end; i = next) {
        next = TextUtils.indexOf(source, '\n', i, end);
        if (next < 0)
            next = end;
        float w = measurePara(paint, source, i, next, textDir);
        if (w > upperLimit) {
            return upperLimit;
        }
        if (w > need)
            need = w;
        next++;
    }
    return need;
}