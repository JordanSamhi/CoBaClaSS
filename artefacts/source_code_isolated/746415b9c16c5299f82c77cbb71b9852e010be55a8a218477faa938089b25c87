public BroadcastRecord getNextBroadcastLocked(final long now){
    if (mCurrentBroadcast != null) {
        return mCurrentBroadcast;
    }
    final boolean someQueued = !mOrderedBroadcasts.isEmpty();
    BroadcastRecord next = null;
    if (!mAlarmBroadcasts.isEmpty()) {
        next = popLocked(mAlarmBroadcasts);
        if (DEBUG_BROADCAST_DEFERRAL && next != null) {
            Slog.i(TAG, "Next broadcast from alarm targets: " + next);
        }
    }
    if (next == null && !mDeferredBroadcasts.isEmpty()) {
        for (int i = 0; i < mDeferredBroadcasts.size(); i++) {
            Deferrals d = mDeferredBroadcasts.get(i);
            if (now < d.deferUntil && someQueued) {
                break;
            }
            if (d.broadcasts.size() > 0) {
                next = d.broadcasts.remove(0);
                mDeferredBroadcasts.remove(i);
                d.deferredBy = calculateDeferral(d.deferredBy);
                d.deferUntil += d.deferredBy;
                insertLocked(mDeferredBroadcasts, d);
                if (DEBUG_BROADCAST_DEFERRAL) {
                    Slog.i(TAG, "Next broadcast from deferrals " + next + ", deferUntil now " + d.deferUntil);
                }
                break;
            }
        }
    }
    if (next == null && someQueued) {
        next = mOrderedBroadcasts.remove(0);
        if (DEBUG_BROADCAST_DEFERRAL) {
            Slog.i(TAG, "Next broadcast from main queue: " + next);
        }
    }
    mCurrentBroadcast = next;
    return next;
}