public static Bitmap createImageThumbnail(@NonNull File file, @NonNull Size size, @Nullable CancellationSignal signal) throws IOException{
    if (signal != null)
        signal.throwIfCanceled();
    final Resizer resizer = new Resizer(size, signal);
    final String mimeType = MediaFile.getMimeTypeForFile(file.getName());
    Bitmap bitmap = null;
    ExifInterface exif = null;
    int orientation = 0;
    if (MediaFile.isExifMimeType(mimeType)) {
        exif = new ExifInterface(file);
        switch(exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, 0)) {
            case ExifInterface.ORIENTATION_ROTATE_90:
                orientation = 90;
                break;
            case ExifInterface.ORIENTATION_ROTATE_180:
                orientation = 180;
                break;
            case ExifInterface.ORIENTATION_ROTATE_270:
                orientation = 270;
                break;
        }
    }
    if (mimeType.equals("image/heif") || mimeType.equals("image/heif-sequence") || mimeType.equals("image/heic") || mimeType.equals("image/heic-sequence")) {
        try (MediaMetadataRetriever retriever = new MediaMetadataRetriever()) {
            retriever.setDataSource(file.getAbsolutePath());
            bitmap = retriever.getThumbnailImageAtIndex(-1, new MediaMetadataRetriever.BitmapParams(), size.getWidth(), size.getWidth() * size.getHeight());
        } catch (RuntimeException e) {
            throw new IOException("Failed to create thumbnail", e);
        }
    }
    if (bitmap == null && exif != null) {
        final byte[] raw = exif.getThumbnailBytes();
        if (raw != null) {
            try {
                bitmap = ImageDecoder.decodeBitmap(ImageDecoder.createSource(raw), resizer);
            } catch (ImageDecoder.DecodeException e) {
                Log.w(TAG, e);
            }
        }
    }
    if (signal != null)
        signal.throwIfCanceled();
    if (bitmap == null) {
        bitmap = ImageDecoder.decodeBitmap(ImageDecoder.createSource(file), resizer);
        return bitmap;
    }
    if (orientation != 0 && bitmap != null) {
        final int width = bitmap.getWidth();
        final int height = bitmap.getHeight();
        final Matrix m = new Matrix();
        m.setRotate(orientation, width / 2, height / 2);
        bitmap = Bitmap.createBitmap(bitmap, 0, 0, width, height, m, false);
    }
    return bitmap;
}