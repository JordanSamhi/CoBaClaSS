public void sendRetrySms(SMSDispatcher.SmsTracker tracker){
    String oldFormat = tracker.mFormat;
    boolean retryUsingImsService = false;
    if (!tracker.mUsesImsServiceForIms && mImsSmsDispatcher.isAvailable()) {
        retryUsingImsService = true;
    }
    String newFormat = retryUsingImsService ? mImsSmsDispatcher.getFormat() : (PhoneConstants.PHONE_TYPE_CDMA == mPhone.getPhoneType()) ? mCdmaDispatcher.getFormat() : mGsmDispatcher.getFormat();
    Rlog.d(TAG, "old format(" + oldFormat + ") ==> new format (" + newFormat + ")");
    if (!oldFormat.equals(newFormat)) {
        HashMap map = tracker.getData();
        if (!(map.containsKey("scAddr") && map.containsKey("destAddr") && (map.containsKey("text") || (map.containsKey("data") && map.containsKey("destPort"))))) {
            Rlog.e(TAG, "sendRetrySms failed to re-encode per missing fields!");
            tracker.onFailed(mContext, SmsManager.RESULT_SMS_SEND_RETRY_FAILED, NO_ERROR_CODE);
            return;
        }
        String scAddr = (String) map.get("scAddr");
        String destAddr = (String) map.get("destAddr");
        SmsMessageBase.SubmitPduBase pdu = null;
        if (map.containsKey("text")) {
            Rlog.d(TAG, "sms failed was text");
            String text = (String) map.get("text");
            if (isCdmaFormat(newFormat)) {
                pdu = com.android.internal.telephony.cdma.SmsMessage.getSubmitPdu(scAddr, destAddr, text, (tracker.mDeliveryIntent != null), null);
            } else {
                pdu = com.android.internal.telephony.gsm.SmsMessage.getSubmitPdu(scAddr, destAddr, text, (tracker.mDeliveryIntent != null), null);
            }
        } else if (map.containsKey("data")) {
            Rlog.d(TAG, "sms failed was data");
            byte[] data = (byte[]) map.get("data");
            Integer destPort = (Integer) map.get("destPort");
            if (isCdmaFormat(newFormat)) {
                pdu = com.android.internal.telephony.cdma.SmsMessage.getSubmitPdu(scAddr, destAddr, destPort.intValue(), data, (tracker.mDeliveryIntent != null));
            } else {
                pdu = com.android.internal.telephony.gsm.SmsMessage.getSubmitPdu(scAddr, destAddr, destPort.intValue(), data, (tracker.mDeliveryIntent != null));
            }
        }
        map.put("smsc", pdu.encodedScAddress);
        map.put("pdu", pdu.encodedMessage);
        tracker.mFormat = newFormat;
    }
    SMSDispatcher dispatcher = retryUsingImsService ? mImsSmsDispatcher : (isCdmaFormat(newFormat)) ? mCdmaDispatcher : mGsmDispatcher;
    dispatcher.sendSms(tracker);
}