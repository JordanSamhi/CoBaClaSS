public static int packData(byte[] message, int offset, int size, long timestamp, byte[] dest){
    if (size > MAX_PACKET_DATA_SIZE) {
        size = MAX_PACKET_DATA_SIZE;
    }
    int length = 0;
    dest[length++] = PACKET_TYPE_DATA;
    System.arraycopy(message, offset, dest, length, size);
    length += size;
    for (int i = 0; i < TIMESTAMP_SIZE; i++) {
        dest[length++] = (byte) timestamp;
        timestamp >>= 8;
    }
    return length;
}