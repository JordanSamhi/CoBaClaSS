public void onRestoreFinished(){
    Slog.v(TAG, "onRestoreFinished()");
    final File filesDir = getFilesDir();
    final File infoStage = new File(filesDir, INFO_STAGE);
    final File imageStage = new File(filesDir, IMAGE_STAGE);
    final File lockImageStage = new File(filesDir, LOCK_IMAGE_STAGE);
    final int sysWhich = FLAG_SYSTEM | (lockImageStage.exists() ? 0 : FLAG_LOCK);
    try {
        restoreFromStage(imageStage, infoStage, "wp", sysWhich);
        restoreFromStage(lockImageStage, infoStage, "kwp", FLAG_LOCK);
        ComponentName wpService = parseWallpaperComponent(infoStage, "wp");
        updateWallpaperComponent(wpService, !lockImageStage.exists());
    } catch (Exception e) {
        Slog.e(TAG, "Unable to restore wallpaper: " + e.getMessage());
    } finally {
        Slog.v(TAG, "Restore finished; clearing backup bookkeeping");
        infoStage.delete();
        imageStage.delete();
        lockImageStage.delete();
        SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
        prefs.edit().putInt(SYSTEM_GENERATION, -1).putInt(LOCK_GENERATION, -1).commit();
    }
}