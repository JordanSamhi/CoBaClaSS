public void dumpProtoLocked(Context context, FileDescriptor fd, List<ApplicationInfo> apps, int flags, long histStart){
    final ProtoOutputStream proto = new ProtoOutputStream(fd);
    prepareForDumpLocked();
    if ((flags & (DUMP_INCLUDE_HISTORY | DUMP_HISTORY_ONLY)) != 0) {
        dumpProtoHistoryLocked(proto, flags, histStart);
        proto.flush();
        return;
    }
    final long bToken = proto.start(BatteryStatsServiceDumpProto.BATTERYSTATS);
    proto.write(BatteryStatsProto.REPORT_VERSION, CHECKIN_VERSION);
    proto.write(BatteryStatsProto.PARCEL_VERSION, getParcelVersion());
    proto.write(BatteryStatsProto.START_PLATFORM_VERSION, getStartPlatformVersion());
    proto.write(BatteryStatsProto.END_PLATFORM_VERSION, getEndPlatformVersion());
    if ((flags & DUMP_DAILY_ONLY) == 0) {
        final BatteryStatsHelper helper = new BatteryStatsHelper(context, false, (flags & DUMP_DEVICE_WIFI_ONLY) != 0);
        helper.create(this);
        helper.refreshStats(STATS_SINCE_CHARGED, UserHandle.USER_ALL);
        dumpProtoAppsLocked(proto, helper, apps);
        dumpProtoSystemLocked(proto, helper);
    }
    proto.end(bToken);
    proto.flush();
}