public void updateExternalState(){
    if (mUiccCard.getCardState() == IccCardStatus.CardState.CARDSTATE_ERROR) {
        setExternalState(IccCardConstants.State.CARD_IO_ERROR);
        return;
    }
    if (mUiccCard.getCardState() == IccCardStatus.CardState.CARDSTATE_RESTRICTED) {
        setExternalState(IccCardConstants.State.CARD_RESTRICTED);
        return;
    }
    if (mUiccCard instanceof EuiccCard && ((EuiccCard) mUiccCard).getEid() == null) {
        if (DBG)
            log("EID is not ready yet.");
        return;
    }
    if (mUiccApplication == null) {
        loge("updateExternalState: setting state to NOT_READY because mUiccApplication is " + "null");
        setExternalState(IccCardConstants.State.NOT_READY);
        return;
    }
    boolean cardLocked = false;
    IccCardConstants.State lockedState = null;
    IccCardApplicationStatus.AppState appState = mUiccApplication.getState();
    PinState pin1State = mUiccApplication.getPin1State();
    if (pin1State == PinState.PINSTATE_ENABLED_PERM_BLOCKED) {
        if (VDBG)
            log("updateExternalState: PERM_DISABLED");
        cardLocked = true;
        lockedState = IccCardConstants.State.PERM_DISABLED;
    } else {
        if (appState == IccCardApplicationStatus.AppState.APPSTATE_PIN) {
            if (VDBG)
                log("updateExternalState: PIN_REQUIRED");
            cardLocked = true;
            lockedState = IccCardConstants.State.PIN_REQUIRED;
        } else if (appState == IccCardApplicationStatus.AppState.APPSTATE_PUK) {
            if (VDBG)
                log("updateExternalState: PUK_REQUIRED");
            cardLocked = true;
            lockedState = IccCardConstants.State.PUK_REQUIRED;
        } else if (appState == IccCardApplicationStatus.AppState.APPSTATE_SUBSCRIPTION_PERSO) {
            if (PersoSubState.isPersoLocked(mUiccApplication.getPersoSubState())) {
                if (VDBG)
                    log("updateExternalState: PERSOSUBSTATE_SIM_NETWORK");
                cardLocked = true;
                lockedState = IccCardConstants.State.NETWORK_LOCKED;
            }
        }
    }
    if (cardLocked) {
        if (mIccRecords != null && (mIccRecords.getLockedRecordsLoaded() || mIccRecords.getNetworkLockedRecordsLoaded())) {
            if (VDBG) {
                log("updateExternalState: card locked and records loaded; " + "setting state to locked");
            }
            setExternalState(lockedState);
        } else {
            if (VDBG) {
                log("updateExternalState: card locked but records not loaded; " + "setting state to NOT_READY");
            }
            setExternalState(IccCardConstants.State.NOT_READY);
        }
        return;
    }
    switch(appState) {
        case APPSTATE_UNKNOWN:
            if (VDBG) {
                log("updateExternalState: app state is unknown; setting state to NOT_READY");
            }
            setExternalState(IccCardConstants.State.NOT_READY);
            break;
        case APPSTATE_DETECTED:
            if (VDBG) {
                log("updateExternalState: app state is detected; setting state to NOT_READY");
            }
            setExternalState(IccCardConstants.State.NOT_READY);
            break;
        case APPSTATE_READY:
            checkAndUpdateIfAnyAppToBeIgnored();
            if (areAllApplicationsReady()) {
                if (areAllRecordsLoaded() && areCarrierPriviligeRulesLoaded()) {
                    if (VDBG)
                        log("updateExternalState: setting state to LOADED");
                    setExternalState(IccCardConstants.State.LOADED);
                } else {
                    if (VDBG) {
                        log("updateExternalState: setting state to READY; records loaded " + areAllRecordsLoaded() + ", carrier privilige rules loaded " + areCarrierPriviligeRulesLoaded());
                    }
                    setExternalState(IccCardConstants.State.READY);
                }
            } else {
                if (VDBG) {
                    log("updateExternalState: app state is READY but not for all apps; " + "setting state to NOT_READY");
                }
                setExternalState(IccCardConstants.State.NOT_READY);
            }
            break;
    }
}