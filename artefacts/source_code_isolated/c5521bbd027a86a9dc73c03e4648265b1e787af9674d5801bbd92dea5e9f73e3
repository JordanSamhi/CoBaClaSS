public void addOnAccountsUpdatedListener(final OnAccountsUpdateListener listener, Handler handler, boolean updateImmediately, String[] accountTypes){
    if (listener == null) {
        throw new IllegalArgumentException("the listener is null");
    }
    synchronized (mAccountsUpdatedListeners) {
        if (mAccountsUpdatedListeners.containsKey(listener)) {
            throw new IllegalStateException("this listener is already added");
        }
        final boolean wasEmpty = mAccountsUpdatedListeners.isEmpty();
        mAccountsUpdatedListeners.put(listener, handler);
        if (accountTypes != null) {
            mAccountsUpdatedListenersTypes.put(listener, new HashSet<String>(Arrays.asList(accountTypes)));
        } else {
            mAccountsUpdatedListenersTypes.put(listener, null);
        }
        if (wasEmpty) {
            IntentFilter intentFilter = new IntentFilter();
            intentFilter.addAction(ACTION_VISIBLE_ACCOUNTS_CHANGED);
            intentFilter.addAction(Intent.ACTION_DEVICE_STORAGE_OK);
            mContext.registerReceiver(mAccountsChangedBroadcastReceiver, intentFilter);
        }
        try {
            mService.registerAccountListener(accountTypes, mContext.getOpPackageName());
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }
    if (updateImmediately) {
        postToHandler(handler, listener, getAccounts());
    }
}