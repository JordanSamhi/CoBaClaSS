public static void write(OutputStream out, IntervalStats stats) throws IOException, IllegalArgumentException{
    final ProtoOutputStream proto = new ProtoOutputStream(out);
    proto.write(IntervalStatsProto.END_TIME_MS, UsageStatsProtoV2.getOffsetTimestamp(stats.endTime, stats.beginTime));
    proto.write(IntervalStatsProto.MAJOR_VERSION, stats.majorVersion);
    proto.write(IntervalStatsProto.MINOR_VERSION, stats.minorVersion);
    try {
        writeStringPool(proto, stats);
    } catch (IllegalArgumentException e) {
        Slog.e(TAG, "Unable to write string pool to proto.", e);
    }
    try {
        writeCountAndTime(proto, IntervalStatsProto.INTERACTIVE, stats.interactiveTracker.count, stats.interactiveTracker.duration);
        writeCountAndTime(proto, IntervalStatsProto.NON_INTERACTIVE, stats.nonInteractiveTracker.count, stats.nonInteractiveTracker.duration);
        writeCountAndTime(proto, IntervalStatsProto.KEYGUARD_SHOWN, stats.keyguardShownTracker.count, stats.keyguardShownTracker.duration);
        writeCountAndTime(proto, IntervalStatsProto.KEYGUARD_HIDDEN, stats.keyguardHiddenTracker.count, stats.keyguardHiddenTracker.duration);
    } catch (IllegalArgumentException e) {
        Slog.e(TAG, "Unable to write some interval stats trackers to proto.", e);
    }
    final int statsCount = stats.packageStats.size();
    for (int i = 0; i < statsCount; i++) {
        try {
            writeUsageStats(proto, IntervalStatsProto.PACKAGES, stats, stats.packageStats.valueAt(i));
        } catch (IllegalArgumentException e) {
            Slog.e(TAG, "Unable to write some usage stats to proto.", e);
        }
    }
    final int configCount = stats.configurations.size();
    for (int i = 0; i < configCount; i++) {
        boolean active = stats.activeConfiguration.equals(stats.configurations.keyAt(i));
        try {
            writeConfigStats(proto, IntervalStatsProto.CONFIGURATIONS, stats, stats.configurations.valueAt(i), active);
        } catch (IllegalArgumentException e) {
            Slog.e(TAG, "Unable to write some configuration stats to proto.", e);
        }
    }
    final int eventCount = stats.events.size();
    for (int i = 0; i < eventCount; i++) {
        try {
            writeEvent(proto, IntervalStatsProto.EVENT_LOG, stats, stats.events.get(i));
        } catch (IllegalArgumentException e) {
            Slog.e(TAG, "Unable to write some events to proto.", e);
        }
    }
    proto.flush();
}