public void waitForSurfacePrepared(CameraCaptureSession session, Surface surface, long timeoutMs){
    synchronized (mPreparedSurfaces) {
        List<Surface> preparedSurfaces = mPreparedSurfaces.get(session);
        if (preparedSurfaces != null && preparedSurfaces.contains(surface)) {
            return;
        }
        try {
            long waitTimeRemaining = timeoutMs;
            while (waitTimeRemaining > 0) {
                long waitStartTime = SystemClock.elapsedRealtime();
                mPreparedSurfaces.wait(timeoutMs);
                long waitTime = SystemClock.elapsedRealtime() - waitStartTime;
                waitTimeRemaining -= waitTime;
                preparedSurfaces = mPreparedSurfaces.get(session);
                if (waitTimeRemaining >= 0 && preparedSurfaces != null && preparedSurfaces.contains(surface)) {
                    return;
                }
            }
            throw new TimeoutRuntimeException("Unable to get Surface prepared in " + timeoutMs + "ms");
        } catch (InterruptedException ie) {
            throw new AssertionError();
        }
    }
}